# **Домашнее задание к занятию 6. «Troubleshooting»**

## **Задача 1**

Перед выполнением задания ознакомьтесь с документацией по [<u>администрированию MongoDB</u>](https://docs.mongodb.com/manual/administration/ "https://docs.mongodb.com/manual/administration/").

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD-операция в MongoDB и её нужно прервать.

Вы как инженер поддержки решили произвести эту операцию:

- напишите список операций, которые вы будете производить для остановки запроса пользователя;

- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB.

*Ответ:*

Для того что бы найти повисший запрос(ну или долго выполняющийся) надо использовать запрос **db.currentOp()** так же чтобы легче было найти можем добавить в запрос условие **"secs_running" : { "$gt" : 180 }** тогда нам отобразятся все операции которые выполняются дольше 180 секунд.

Далее узнав ID запроса мы его можем остановить с помощью запроса **db.killOp()**

В первую очередь я бы стал смотреть проставлены Индексы, и эффективность их работы(по возможности поменял бы их и изменил структуру данных)

Возможно рассматривал бы решение данной проблемы через шардинг, что бы распределить нагрузку на несколько серверов

Далее стал бы рассматривать в направлении увеличения буфера\количество потоков, возможно увеличил бы кэш для улучшения производительности.

И ещё бы чаще смотрел/ мониторил запросы(логирование) производительности чт обы быстрей реагировать на возникшие проблемы.

## **Задача 2**

Перед выполнением задания познакомьтесь с документацией по [<u>Redis latency troobleshooting</u>](https://redis.io/topics/latency "https://redis.io/topics/latency").

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. Причём отношение количества записанных key-value-значений к количеству истёкших значений есть величина постоянная и увеличивается пропорционально количеству реплик сервиса.

При масштабировании сервиса до N реплик вы увидели, что:

- сначала происходит рост отношения записанных значений к истекшим,

- Redis блокирует операции записи.

Как вы думаете, в чём может быть проблема?

*Ответ:*

1. Я думаю что в первую очередь рост отношения записанных значений к истекшим связан с тем что мы используем механизм TTL и память переполняется истекшими ключами.

2. В связи с тем что Redis является однопоточной базой данных, во время выполнения операции записи или удаления ключа с истекшим TTL, он может блокировать весь процесс и если у нас есть большая нагрузка то это будет заметно.

## **Задача 3**

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей в таблицах базы пользователи начали жаловаться на ошибки вида:

InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '

Как вы думаете, почему это начало происходить и как локализовать проблему?

Какие пути решения этой проблемы вы можете предложить?

*Ответ:*

Возможные причины это могут быть потеря сетевого соединения или запрос очень длинный. Так же исходя из условий что ошибка возникает из-за количество записей можно предположить что во время большой нагрузки на сервер происходит разрыв соединения.

Для решения данной проблемы в первую очередь я бы стал смотреть логи, потом бы стал смотреть настройки самого MySQL(ограничения на количество подключений, время запроса, как подключается клиент и подключается ли он вообще) Возможно проанализировав полученные данные попробывал бы увеличить значение параметров таких как connect_timeout, interactive_timeout, wait_timeout net_read_timeout

## **Задача 4**

Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с большим объёмом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

postmaster invoked oom-killer

Как вы думаете, что происходит?

Как бы вы решили эту проблему?

*Ответ:*

ну исходя из ошибки postmaster invoked oom-killer очевидно что нам не хватает оперативной памяти я думаю что пути решения данной проблемы в первую очередь можно решить с помощью увеличения количества памяти.

Если бы это не помогло я бы стал смотреть настройки которые у нас перешли при переносе и соответствуют ли они нашим характеристикам сервера.

Если бы дальше проблема осталась стал бы анализировать процессы которые потребляют больше всех памяти.
